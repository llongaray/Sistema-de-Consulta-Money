{% extends "bases/base.html" %}
{% load static %}

{% block title %}Ficha do Cliente{% endblock %}
{% block addcss_extra %}
<link rel="stylesheet" href="{% static 'consultas.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-D7a7v08t8PR0N0Ct1NQmVKR2BtqS9rBU2K4qj5SAFceh2TF44p4ZdjwF8XzNDBIQkJ0IG4KfYq2U5L2S3OLQsg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
{% endblock %}
{% block content %}
<div class="container">
    <h2>Resultado da Consulta</h2>
    <h4 class="alert alert-success">Consulta realizada com sucesso!</h4>
    <div class="title-icone ficha">
        <i class="fas fa-clipboard"></i>
        <h3>Ficha do Cliente</h3>
    </div>
    
    
    <div class="card mb-3">
        <div class="card-header">
            <h3>Contratos de Empréstimo</h3>
        </div>
        <div class="card-body">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th scope="col">Banco</th>
                        <th scope="col">Valor</th>
                        <th scope="col">Prazo</th>
                    </tr>
                </thead>
                <tbody>
                    {% for debito in context_debitos %}
                    <tr>
                        <td>{{ debito.banco_cliente }}</td>
                        <td>R$ {{ debito.valor_cliente|floatformat:"2" }}</td>
                        <td>{{ debito.prazo_cliente }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3">Nenhum contrato de empréstimo encontrado.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    

    <div class="card mb-3">
        <div class="card-header">
            <h3>Informações Cadastrais</h3>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="aline-between">
                        <span>
                            <p class="bold-title">Nome:</p><p class="containt-info">{{ context_info.nome_cliente }}</p>
                        </span>
                        <span>
                            <p class="bold-title">CPF:</p><p class="containt-info">{{ context_info.cpf_cliente }}</p>
                        </span>
                        <span>
                            <p class="bold-title">Estado (UF):</p><p class="containt-info">{{ context_info.uf_cliente }}</p>
                        </span>
                    </div>
                    <div class="aline-between">
                        <span>
                            <p class="bold-title">Cidade:</p><p class="containt-info">{{ context_info.cidade_cliente }}</p>
                        </span>
                        <span>
                            <p class="bold-title">Telefone:</p><p class="containt-info">{{ context_info.telefone_cliente }}</p>
                        </span>
                        <span>
                            <p class="bold-title">Idade:</p><p class="containt-info">{{ context_info.idade_cliente }}</p>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    

    <div class="card mb-3">
        <div class="card-header">
            <h3>Margem Consignável</h3>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    {% for debito in context_debitos %}
                    <div class="aline-between">
                        <span>
                            <p class="bold-title">Margem 30%:</p><p class="containt-info">R$ {{ debito.valor_cliente|floatformat:"2" }}</p>
                        </span>
                        <span>
                            <p class="bold-title">Margem 5%:</p><p class="containt-info">R$ {{ debito.margem_cartao_cliente|floatformat:"2" }}</p>
                        </span>
                        <span>
                            <p class="bold-title">Situação:</p><p class="containt-info">{{ debito.situacao_cliente }}</p>
                        </span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    


    <div class="card mb-3">
        <div class="card-header">
            <h3>Simulador</h3>
        </div>
        
        <div class="title-icone novo-emprestimo">
            <i class="fas fa-money-check-alt"></i>
            <h3>Novo Empréstimo</h3>
        </div>
        
        
        <div class="card-body calc-marge">
            <div class="row calc-marge-row">
                <div class="col-md-6 calc-marge-sm">
                    <div class="aline-between calc-marge-sm-2">
                        <span>
                            <p class="bold-title">Margem 30%:</p>
                            <p><input type="text" id="coeficiente" placeholder="Digite aqui"></p>
                        </span>
                        <span>
                            <p class="bold-title">Coeficiente do Dia:</p>
                            <p><input type="text" id="coeficiente" placeholder="Digite aqui"></p>
                        </span>
                        <span>
                            <p class="bold-title">Valor Liberado:</p>
                            <p><input type="text" id="coeficiente" placeholder="Digite aqui"></p>
                        </span>
                    </div>
                    <button class="btn btn-primary" onclick="calcularValorLiberado()">Calcular</button>
                </div>
                
                <div class="col-md-6">
                    <div class="title-icone">
                        <i class="fas fa-calculator"></i>
                        <h3>Calculadora do Cidadão - Banco Central</h3>
                    </div>
                    <div class="calc-cid-bc aline-between">
                        <img src="{% static 'logo-banco.png' %}" alt="Logo Banco Central" class="mb-2 logo-banco">
                        
                        <div class="form-group">
                            <label for="numMeses">Nº de Meses:</label>
                            <input type="text" id="numMeses" class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label for="taxaJuros">Taxa de Juros Mensal:</label>
                            <input type="text" id="taxaJuros" class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label for="valorPrestacao">Valor da Prestação:</label>
                            <input type="text" id="valorPrestacao" class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label for="valorFinanciado">Valor financiado:</label>
                            <input type="text" id="valorFinanciado" class="form-control">
                        </div>
                        
                        <button class="btn btn-primary btn-sm" onclick="calcular()">Calcular</button>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
    

    <script>
        // Função para calcular o número de meses
        function calculateNumberOfMonths(q0, p, j) {
            j = j / 100; // Converte taxa de juros para decimal
            let n = Math.log(p / (p - j * q0)) / Math.log(1 + j);
            return Math.ceil(n); // Arredonda para cima
        }
    
        // Função para calcular a taxa de juros mensal
        function calculateMonthlyInterestRate(q0, p, n, tolerance = 0.000001) {
            let jLow = 0;
            let jHigh = 1;
            let jMid = (jLow + jHigh) / 2;
    
            while ((jHigh - jLow) > tolerance) {
                let calculatedP = (jMid * q0) / (1 - Math.pow(1 + jMid, -n));
                if (calculatedP > p) {
                    jHigh = jMid;
                } else {
                    jLow = jMid;
                }
                jMid = (jLow + jHigh) / 2;
            }
            
            return jMid * 100; // Converte de decimal para porcentagem
        }
    
        // Função para calcular o valor da prestação
        function calculateInstallment(q0, n, j) {
            j = j / 100; // Converte taxa de juros para decimal
            let p = (j * q0) / (1 - Math.pow(1 + j, -n));
            return p;
        }
    
        // Função para calcular o valor financiado
        function calculateFinancedAmount(p, n, j) {
            j = j / 100; // Converte taxa de juros para decimal
            let q0 = (1 - Math.pow(1 + j, -n)) / j * p;
            return q0;
        }
    
        // Função para determinar qual cálculo realizar
        function calcular() {
            let numMeses = document.getElementById('numMeses').value;
            let taxaJuros = document.getElementById('taxaJuros').value;
            let valorPrestacao = document.getElementById('valorPrestacao').value;
            let valorFinanciado = document.getElementById('valorFinanciado').value;
    
            // Contagem de inputs vazios
            let emptyCount = [numMeses, taxaJuros, valorPrestacao, valorFinanciado].filter(x => x === "").length;
    
            if (emptyCount !== 1) {
                alert('Por favor, preencha exatamente 3 campos.');
                return;
            }
    
            // Chama a função correta com base nos inputs preenchidos
            if (numMeses === "") {
                let q0 = parseFloat(valorFinanciado);
                let p = parseFloat(valorPrestacao);
                let j = parseFloat(taxaJuros);
                let n = calculateNumberOfMonths(q0, p, j);
                alert('Número de meses: ' + n);
                document.getElementById('numMeses').value = n;
            } else if (taxaJuros === "") {
                let q0 = parseFloat(valorFinanciado);
                let p = parseFloat(valorPrestacao);
                let n = parseInt(numMeses);
                let j = calculateMonthlyInterestRate(q0, p, n);
                alert('Taxa de juros mensal: ' + j.toFixed(2) + '%');
                document.getElementById('taxaJuros').value = j.toFixed(2);
            } else if (valorPrestacao === "") {
                let q0 = parseFloat(valorFinanciado);
                let n = parseInt(numMeses);
                let j = parseFloat(taxaJuros);
                let p = calculateInstallment(q0, n, j);
                alert('Valor da prestação: ' + p.toFixed(2));
                document.getElementById('valorPrestacao').value = p.toFixed(2);
            } else if (valorFinanciado === "") {
                let p = parseFloat(valorPrestacao);
                let n = parseInt(numMeses);
                let j = parseFloat(taxaJuros);
                let q0 = calculateFinancedAmount(p, n, j);
                alert('Valor financiado: ' + q0.toFixed(2));
                document.getElementById('valorFinanciado').value = q0.toFixed(2);
            }
        }
    </script>
{% endblock %}
